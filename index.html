<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Video Gallery</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            line-height: 1.5;
            overflow-x: hidden;
            scroll-behavior: smooth;
            scroll-snap-type: y mandatory;
        }
        .intro-text {
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            scroll-snap-align: start;
        }
        .video-section {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            scroll-snap-align: start;
        }
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        .caption {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 14px;
            color: #ccc;
            z-index: 10;
            pointer-events: none;
        }
        .spacer {
            height: 100px;
            background: #000;
            scroll-snap-align: start;
        }
    </style>
</head>
<body>
    <!-- Intro text section -->
    <section class="intro-text">
        <p>The future of digital art is here. These groundbreaking videos showcase innovative techniques that are transforming the creative industry. Artists worldwide are adopting these methods to push boundaries and explore new visual languages.</p>
        <!-- Остальной текст -->
    </section>

    <div class="spacer"></div>

    <!-- Видео секции (все 31 видео) -->
    <section class="video-section">
        <div class="video-container">
            <iframe id="ytplayer1" data-src="https://www.youtube.com/embed/0AimnC3n1lY?enablejsapi=1" frameborder="0" allowfullscreen></iframe>
        </div>
        <div class="caption">Fractal Dreamscapes - Generative Art Exploration (2023)</div>
    </section>

    <div class="spacer"></div>

    <section class="video-section">
        <div class="video-container">
            <iframe id="ytplayer2" data-src="https://www.youtube.com/embed/MW3tpuubqqU?enablejsapi=1" frameborder="0" allowfullscreen></iframe>
        </div>
        <div class="caption">Neural Character Design - AI Assisted Creation Process</div>
    </section>

    <!-- Остальные видео-секции с ytplayer3 до ytplayer31 -->
    <!-- ... -->

    <script>
        // Конфигурация YouTube
        const youtubeConfig = {
            autoplay: 1,
            mute: 1,
            loop: 1,
            controls: 0,
            rel: 0,
            modestbranding: 1,
            fs: 0,
            disablekb: 1,
            iv_load_policy: 3,
            showinfo: 0
        };

        // Состояние приложения
        const appState = {
            players: {},
            activePlayer: null,
            isScrolling: false,
            lastScrollTime: 0
        };

        // Инициализация YouTube API
        function initYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // Создание URL с параметрами
        function getYouTubeUrl(videoId) {
            const params = new URLSearchParams();
            Object.entries(youtubeConfig).forEach(([key, value]) => {
                params.set(key, value);
            });
            params.set('playlist', videoId); // Для loop
            return `https://www.youtube.com/embed/${videoId}?${params.toString()}`;
        }

        // Инициализация Intersection Observer
        function initIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                const now = Date.now();
                
                // Защита от частых срабатываний
                if (now - appState.lastScrollTime < 100) return;
                appState.lastScrollTime = now;

                entries.forEach(entry => {
                    const iframe = entry.target.querySelector('iframe');
                    if (!iframe) return;

                    const player = appState.players[iframe.id];
                    if (!player) return;

                    if (entry.isIntersecting) {
                        // Видео в зоне видимости
                        if (appState.activePlayer && appState.activePlayer !== player) {
                            appState.activePlayer.pauseVideo();
                            appState.activePlayer.setPlaybackQuality('default');
                        }
                        
                        player.playVideo();
                        player.setPlaybackQuality('hd1080');
                        appState.activePlayer = player;
                    } else {
                        // Видео вне зоны видимости
                        if (appState.activePlayer === player) {
                            player.pauseVideo();
                            player.setPlaybackQuality('default');
                            appState.activePlayer = null;
                        }
                    }
                });
            }, { 
                threshold: 0.7,
                rootMargin: "0px 0px -100px 0px" 
            });

            document.querySelectorAll('.video-section').forEach(section => {
                observer.observe(section);
            });
        }

        // Инициализация всех плееров
        function onYouTubeIframeAPIReady() {
            document.querySelectorAll('.video-section').forEach((section, index) => {
                const iframe = section.querySelector('iframe');
                if (!iframe) return;

                const videoId = iframe.dataset.src.split('/embed/')[1].split('?')[0];
                iframe.src = getYouTubeUrl(videoId);

                appState.players[iframe.id] = new YT.Player(iframe.id, {
                    events: {
                        'onReady': (e) => onPlayerReady(e, iframe.id),
                        'onStateChange': onPlayerStateChange
                    }
                });
            });

            initIntersectionObserver();
            setupSmoothScrolling();
        }

        // Обработчик готовности плеера
        function onPlayerReady(event, playerId) {
            event.target.setPlaybackQuality('hd1080');
            event.target.a.style.filter = 'brightness(1)';
            
            // Авто-полноэкран для первого видео
            if (playerId === 'ytplayer1') {
                event.target.playVideo();
                appState.activePlayer = event.target;
                enterFullscreen(event.target.a.closest('.video-section'));
            }
        }

        // Обработчик изменения состояния
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                event.target.seekTo(0);
                event.target.playVideo();
            }
        }

        // Функция полноэкранного режима
        function enterFullscreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        // Настройка плавной прокрутки
        function setupSmoothScrolling() {
            const sections = document.querySelectorAll('.video-section, .intro-text');
            let isScrolling = false;
            
            // Обработчик колеса мыши
            window.addEventListener('wheel', (e) => {
                if (isScrolling) {
                    e.preventDefault();
                    return;
                }

                if (Math.abs(e.deltaY) > 50) {
                    e.preventDefault();
                    const direction = e.deltaY > 0 ? 1 : -1;
                    scrollToNextSection(direction);
                }
            }, { passive: false });

            // Обработчик касаний для мобильных
            let touchStartY = 0;
            document.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const diff = touchStartY - touchEndY;
                
                if (Math.abs(diff) > 50 && !isScrolling) {
                    const direction = diff > 0 ? 1 : -1;
                    scrollToNextSection(direction);
                }
            }, { passive: true });

            // Прокрутка к следующей секции
            function scrollToNextSection(direction) {
                if (isScrolling) return;
                
                const currentScroll = window.scrollY;
                let targetSection = null;
                let minDistance = Infinity;

                sections.forEach(section => {
                    const distance = Math.abs(section.offsetTop - currentScroll);
                    if ((direction > 0 && section.offsetTop > currentScroll + 10) || 
                        (direction < 0 && section.offsetTop < currentScroll - 10)) {
                        if (distance < minDistance) {
                            minDistance = distance;
                            targetSection = section;
                        }
                    }
                });

                if (targetSection) {
                    isScrolling = true;
                    window.scrollTo({
                        top: targetSection.offsetTop,
                        behavior: 'smooth'
                    });

                    setTimeout(() => {
                        isScrolling = false;
                    }, 800);
                }
            }
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            initYouTubeAPI();
        });
    </script>
</body>
</html>
