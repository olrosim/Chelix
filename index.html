<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Gallery</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }
        
        .video-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            scroll-snap-align: start;
        }
        
        .video-poster {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            cursor: pointer;
        }
        
        .video-iframe {
            position: absolute;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .video-iframe.active {
            opacity: 1;
        }
        
        .video-caption {
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 18px;
            z-index: 3;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 4;
            display: none;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="video-gallery">
        <!-- Видео будут добавлены через JS -->
    </div>

    <script>
        // Конфигурация
        const config = {
            videoId: 'XfxyGbh5dmI',
            videoCount: 20,
            posterQuality: 'maxresdefault'
        };
        
        // Состояние
        const state = {
            players: {},
            activeVideo: null,
            scrollDebounce: null
        };
        
        // Инициализация
        function init() {
            createVideoElements();
            loadYouTubeAPI();
            setupScrollHandler();
        }
        
        // Создание элементов видео
        function createVideoElements() {
            const gallery = document.getElementById('video-gallery');
            
            for (let i = 0; i < config.videoCount; i++) {
                const container = document.createElement('div');
                container.className = 'video-container';
                container.dataset.index = i;
                
                container.innerHTML = `
                    <img class="video-poster" 
                         src="https://img.youtube.com/vi/${config.videoId}/${config.posterQuality}.jpg" 
                         alt="Video ${i+1}">
                    <div class="loading-spinner"></div>
                    <div class="video-caption">Video ${i+1}</div>
                    <iframe class="video-iframe"
                            data-src="https://www.youtube.com/embed/${config.videoId}?enablejsapi=1&autoplay=1&mute=1&playsinline=1"
                            frameborder="0"
                            allowfullscreen></iframe>
                `;
                
                gallery.appendChild(container);
                
                // Обработчик клика по постеру
                container.querySelector('.video-poster').addEventListener('click', () => {
                    setActiveVideo(i);
                });
            }
        }
        
        // Загрузка YouTube API
        function loadYouTubeAPI() {
            if (!window.YT) {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                
                window.onYouTubeIframeAPIReady = initPlayers;
            } else {
                initPlayers();
            }
        }
        
        // Инициализация плееров
        function initPlayers() {
            document.querySelectorAll('.video-iframe').forEach((iframe, index) => {
                if (iframe.dataset.src) {
                    iframe.src = iframe.dataset.src;
                }
                
                state.players[index] = new YT.Player(iframe, {
                    events: {
                        'onReady': (e) => onPlayerReady(e, index),
                        'onStateChange': (e) => onPlayerStateChange(e, index)
                    }
                });
            });
        }
        
        // Обработчик готовности плеера
        function onPlayerReady(event, index) {
            console.log(`Player ${index} ready`);
        }
        
        // Обработчик изменения состояния
        function onPlayerStateChange(event, index) {
            if (event.data === YT.PlayerState.ENDED) {
                event.target.seekTo(0);
                event.target.playVideo();
            }
        }
        
        // Установка активного видео
        function setActiveVideo(index) {
            if (state.activeVideo === index) return;
            
            // Пауза предыдущего видео
            if (state.activeVideo !== null && state.players[state.activeVideo]) {
                const prevIframe = document.querySelector(`.video-container[data-index="${state.activeVideo}"] .video-iframe`);
                prevIframe.classList.remove('active');
                state.players[state.activeVideo].pauseVideo();
            }
            
            // Запуск нового видео
            state.activeVideo = index;
            const currentIframe = document.querySelector(`.video-container[data-index="${index}"] .video-iframe`);
            currentIframe.classList.add('active');
            
            if (state.players[index]) {
                state.players[index].playVideo();
            }
        }
        
        // Определение центрального видео
        function checkActiveVideo() {
            const containers = document.querySelectorAll('.video-container');
            const viewportCenter = window.innerHeight / 2;
            
            containers.forEach(container => {
                const rect = container.getBoundingClientRect();
                const containerCenter = rect.top + rect.height / 2;
                
                // Если центр контейнера близок к центру экрана
                if (Math.abs(viewportCenter - containerCenter) < 100) {
                    const index = parseInt(container.dataset.index);
                    if (state.activeVideo !== index) {
                        setActiveVideo(index);
                    }
                    return;
                }
            });
        }
        
        // Обработчик скролла с дебаунсом
        function setupScrollHandler() {
            window.addEventListener('scroll', () => {
                clearTimeout(state.scrollDebounce);
                state.scrollDebounce = setTimeout(checkActiveVideo, 100);
            });
            
            // Проверка при загрузке
            setTimeout(checkActiveVideo, 500);
        }
        
        // Запуск приложения
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
